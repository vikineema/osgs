<!DOCTYPE html>
<html lang="en-gb">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>OSGS - SCP - PR</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" integrity="sha256-NuCn4IvuZXdBaFKJOAcsU2Q3ZpwbdFisd5dux4jkQ5w=" crossorigin="anonymous"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap-theme.css" integrity="sha256-xOpS+e/dER8z72w+qryCieOGysQI8cELAVt3MHG0phY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tooltipster@4.2.7/dist/css/tooltipster.bundle.min.css" integrity="sha256-Qc4lCfqZWYaHF5hgEOFrYzSIX9Rrxk0NPHRac+08QeQ=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tooltipster@4.2.7/dist/css/plugins/tooltipster/sideTip/themes/tooltipster-sideTip-light.min.css" integrity="sha256-Wa1I4jhSXeWd3N6RhfPlkqr1WlT+zS3Vh2YGCg0129E=" crossorigin="anonymous">
<link href="https://fonts.googleapis.com/css?family=Open+Sans|Source+Code+Pro|Source+Sans+Pro|Source+Serif+Pro|Roboto|Roboto+Mono" rel="stylesheet">
<link href="https://fonts.red-dove.com/iosevka-ss09-regular/webfont.css" rel="stylesheet">

    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/sizzle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/sizzle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/css.css" type="text/css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js" integrity="sha256-G7A4JrJjJlFqP0yamznwPjAApIKPkadeHfyIwiaa9e0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/tooltipster@4.2.7/dist/js/tooltipster.bundle.min.js" integrity="sha256-NOU7KrY2aTI4PxDegqYUIknk9qfxVCS0E4JfE9aMwaA=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false,
        SOURCELINK_SUFFIX: '.txt'
      };
      $(document).data('sizzle', {on_load: []});
    </script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/js/js.js"></script>
      <script src="../../app-data.js"></script>
<link rel="index" title="Index" href="../genindex.html" />
<link rel="search" title="Search" href="../search.html" />
<link rel="next" title="Lizmap - WIP" href="lizmap.html" />
<link rel="prev" title="Metabase - PR" href="metabase.html" />

</head>
<body class="full-height test">
<noscript>
  <div>
    <div id="noscript-message">JavaScript is not enabled. It is needed for this website to work.</div>
  </div>
</noscript>
<div id="whole-page" class="container-fluid content full-height">
  <div id="header-row" class="row">
    <div id="header-container" class="col-md-12">
      <div id="hdr-left">
        <i class="fa fa-bars menu-toggle"></i>
        
<a href="../index.html" class="text-logo">OSGS 1.0 documentation</a>

      </div>
      <div id="hdr-centre" class="text-center stretch">
        <h3 title="SCP - PR">SCP - PR</h3>
        <h6>SCP - PR </h6>
      </div>
      <div id="hdr-search">
        
<div class="input-group" title="Enter something to search for and then either press Enter or click the magnifying glass">
  <input type="text" class="form-control search-query" placeholder="Search docs ...">
  <div class="input-group-addon">
    <i class="fa fa-search"></i>
  </div>
</div>
      </div>

      <div id="hdr-source">
        <a href="../_sources/services/scp.md.txt" class="btn btn-default" title="See the source for this page"><i class="fa fa-code"></i></a>
      </div>

      <div id="hdr-right">
        
  
  <div class="prev-next">
    
      <div class="pull-left">
        <a class="btn btn-default prev" href="metabase.html" title="Previous chapter (Metabase - PR)"><i class="fa fa-chevron-left mr-1em" aria-hidden="true"></i><span class="btn-text">Metabase - PR</span></a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default next" href="lizmap.html" title="Next chapter (Lizmap - WIP)"><span class="btn-text">Lizmap - WIP</span>&nbsp;<i class="fa fa-chevron-right ml-1em" aria-hidden="true"></i></a>
      </div>
    </div>
  
      </div>
      <div id="alt-hdr-right">

        <a href="metabase.html"><i class="fa fa-chevron-left mr-8"></i></a>


        <a href="../index.html"><i class="fa fa-home mr-8"></i></a>


        <a href="../search.html"><i class="fa fa-search mr-8"></i></a>



        <a href="lizmap.html"><i class="fa fa-chevron-right"></i></a>

      </div>
    </div>
  </div>

  <div id="content-row" class="row">
    <div id="page-content" class="col-md-12 flex-col">
      <div id="content-container">
        <div id="nav">
          
  <div class="navsidebar">
    <div id="sidebar-search">
      
<div class="input-group" title="Enter something to search for and then either press Enter or click the magnifying glass">
  <input type="text" class="form-control search-query" placeholder="Search docs ...">
  <div class="input-group-addon">
    <i class="fa fa-search"></i>
  </div>
</div>
    </div>
      <div class="sidebar-block">
        <div class="sidebar-tocheading">
          <div class="pull-left">
            <h2>Table Of Contents</h2>
          </div>
          <div class="pull-right" title="Hide this sidebar (hover at left edge to bring it back)"><i class="fa fa-chevron-left hidetoc"></i></div>
        </div>
        <div class="sidebar-toc">
      
        <div style="clear: both"></div>
      
        
  
    <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html#introduction">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html#installation">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html#osgs">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utilities/index.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflows/index.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../blueprints/index.html#blueprints">Blueprints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html#troubleshooting-faq">Troubleshooting FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html#osgs-roadmap">OSGS Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Credits.html#credits">Credits</a></li>
</ul>

  
        </div>
      </div>
  </div>
        </div>
        <div id="content" tabindex="0" class="stretch">
          <div id="mnav">
            
  
    <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html#introduction">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html#installation">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html#osgs">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../utilities/index.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflows/index.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../blueprints/index.html#blueprints">Blueprints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ.html#troubleshooting-faq">Troubleshooting FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roadmap.html#osgs-roadmap">OSGS Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Credits.html#credits">Credits</a></li>
</ul>

  
          </div>
          <div class="body">
            
  <div class="section" id="scp-pr-pr">
<h1>SCP - PR <img alt="PR" src="https://img.shields.io/badge/pr-green?style=for-the-badge" /><a class="headerlink" href="#scp-pr-pr" title="Permalink to this heading">Â¶</a></h1>
<blockquote>
<div><strong>Note</strong>: With the provision of the filebrowser service, we will probably deprecate this service.</div></blockquote>
<p>The SCP (secure copy) containers have been arranged so that there are some
standard containers out of the box. Each container has its data stored in its
own docker volume as well. The data is somewhat isolated and there are
containers for QGIS projects, fonts, SVGs that your QGIS projects might
reference, general file sharing, uploading data to ODM, etc. The SCP service is
designed to only support connections with SSH public-private key encryption and
password based authentication. The way that you provision users into it is that
you copy the SSH public key into a file in the configuration folder for SCP and
then that user will be allowed to make the connection to whichever SCP share
that you have created for them. The SCP container can be used to copy a QGIS
project file from your desktop up to the server with all the QGIS resources
that it needs such as shapefiles. The QGIS Server instance can then be used to
access the project from the OGC web services.</p>
<p><strong>Project Website:</strong></p>
<p><strong>Project Source Repository:</strong></p>
<p><strong>Project Project Technical Documentation:</strong></p>
<p><strong>Docker Repository:</strong></p>
<p><strong>Docker Source Repository:</strong></p>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">Â¶</a></h2>
</div>
<div class="section" id="deployment">
<h2>Deployment<a class="headerlink" href="#deployment" title="Permalink to this heading">Â¶</a></h2>
</div>
<div class="section" id="enabling">
<h2>Enabling<a class="headerlink" href="#enabling" title="Permalink to this heading">Â¶</a></h2>
</div>
<div class="section" id="disabling">
<h2>Disabling<a class="headerlink" href="#disabling" title="Permalink to this heading">Â¶</a></h2>
</div>
<div class="section" id="accessing-the-running-services">
<h2>Accessing the running services<a class="headerlink" href="#accessing-the-running-services" title="Permalink to this heading">Â¶</a></h2>
</div>
<div class="section" id="additional-notes">
<h2>Additional Notes<a class="headerlink" href="#additional-notes" title="Permalink to this heading">Â¶</a></h2>
</div>
<div class="section" id="scp-file-drop-shares">
<h2>SCP File Drop Shares<a class="headerlink" href="#scp-file-drop-shares" title="Permalink to this heading">Â¶</a></h2>
<p>This is a container intended for users to upload files for publication on the
server. It runs on port 2222 so we need to expose that through the firewall:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ufw</span> <span class="n">allow</span> <span class="mi">2222</span>
</pre></div>
</div>
<p>You can add your public keys from the host e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">~/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keys</span> <span class="o">&gt;</span> <span class="n">scp_conf</span><span class="o">/</span><span class="n">gis_projects</span>
</pre></div>
</div>
<p>Or copy them in by other means. Each file you create in scp_conf will be a user
name when the scp container runs, with itâs own directory in the storage
volume, unless an explicit storage volume has been pre-defined (see list of
these below). Each file should contain a list of public keys. If you add a key
at some point, or a new user file, you may need to restart the container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">profile</span><span class="o">=</span><span class="n">scp</span> <span class="n">restart</span>
</pre></div>
</div>
<p>The following scp shares are made for the various purposes listed below. You
need to follow the same pattern of creating a config file for each. These
shares each have a dedicated volume associated with it which is also mounted
into the associated server container.</p>
<hr class="docutils" />
<ul class="simple">
<li><strong>User:</strong> geoserver_data</li>
<li><strong>Named Volume:</strong> scp_geoserver_data</li>
<li><strong>Volume Mounted To:</strong> scp, geoserver</li>
<li><strong>Notes:</strong> Copy vector and raster datasets here for publishing in GeoServer.</li>
<li><strong>Example Use:</strong> <code class="docutils literal notranslate"><span class="pre">sftp://geoserver_data&#64;&lt;hostname&gt;:2222/home/geoserver_data</span></code></li>
</ul>
<hr class="docutils" />
<ul class="simple">
<li><strong>User:</strong> qgis_projects</li>
<li><strong>Named Volume:</strong> scp_qgis_projects</li>
<li><strong>Volume Mounted To:</strong> scp, qgis-server</li>
<li><strong>Notes:</strong> Copy QGIS projects and data here for publishing with QGIS Server.
See notes on directory layout below.</li>
<li><strong>Example Use:</strong> <code class="docutils literal notranslate"><span class="pre">sftp://qgis_projects&#64;&lt;hostname&gt;:2222/home/qgis_projects</span></code></li>
</ul>
<hr class="docutils" />
<ul class="simple">
<li><strong>User:</strong> qgis_svgs</li>
<li><strong>Named Volume:</strong> scp_qgis_svgs</li>
<li><strong>Volume Mounted To:</strong> scp, qgis-server</li>
<li><strong>Notes:</strong> Embed SVGs in styles by preference in QGIS. Use this drop if you
have no way to use embeded SVGS.</li>
<li><strong>Example Use:</strong> ``sftp://qgis_svgs&#64;<hostname>:2222/home/qgis_svgs`</li>
</ul>
<hr class="docutils" />
<ul class="simple">
<li><strong>User:</strong> qgis_fonts</li>
<li><strong>Named Volume:</strong> scp_qgis_fonts</li>
<li><strong>Volume Mounted To:</strong> scp, qgis-server</li>
<li><strong>Notes:</strong> Copy fonts directly into the root folder.</li>
<li><strong>Example Use:</strong> <code class="docutils literal notranslate"><span class="pre">sftp://qgis_fonts&#64;&lt;hostname&gt;:2222/home/qgis_fonts</span></code></li>
</ul>
<hr class="docutils" />
<ul class="simple">
<li><strong>User:</strong> hugo_data</li>
<li><strong>Named Volume:</strong> scp_hugo_data</li>
<li><strong>Volume Mounted To:</strong> scp, hugo*</li>
<li><strong>Notes:</strong> Upload markdown files for static site generation with Hugo.</li>
<li><strong>Example Use:</strong> <code class="docutils literal notranslate"><span class="pre">sftp://hugo_data&#64;&lt;hostname&gt;:2222/home/hugo_data</span></code></li>
</ul>
<hr class="docutils" />
<ul class="simple">
<li><strong>User:</strong> odm_data</li>
<li><strong>Named Volume:</strong> scp_odm_data</li>
<li><strong>Volume Mounted To:</strong> scp, odm *</li>
<li><strong>Notes:</strong> Upload imagery data for processing with ODM</li>
<li><strong>Example Use:</strong> <code class="docutils literal notranslate"><span class="pre">sftp://odm_data&#64;&lt;hostname&gt;:2222/home/odm_data</span></code></li>
</ul>
<hr class="docutils" />
<ul class="simple">
<li><strong>User:</strong> general_data</li>
<li><strong>Named Volume:</strong> scp_general_data</li>
<li><strong>Volume Mounted To:</strong> scp</li>
<li><strong>Notes:</strong> General sharing directory. Later we will publish this under nginx
for public downloads. Donât put any sensitive data in here.</li>
<li><strong>Example Use:</strong> <code class="docutils literal notranslate"><span class="pre">sftp://general_data&#64;&lt;hostname&gt;:2222/home/general_data</span></code></li>
</ul>
<hr class="docutils" />
<p><strong>Note:</strong> Any user connecting to any of these shares will be able to see all
other files from all other users. They will only have write access to the
folder they are connecting to, for all other shares their access will be read
only. If you want to further partition the access to files you can create
multiple scp services, each with one of the mount points listed above. In so
doing users would not be able to see the other mount points listed above.</p>
</div>
<div class="section" id="directory-layout-for-the-qgis-projects-folder">
<h2>Directory layout for the QGIS projects folder<a class="headerlink" href="#directory-layout-for-the-qgis-projects-folder" title="Permalink to this heading">Â¶</a></h2>
<p>When adding projects to the qgis_projects folder, you need to follow this
convention strictly for the projects to be recognised by QGIS Server:</p>
<p><code class="docutils literal notranslate"><span class="pre">qgis_projects/&lt;project_name&gt;/&lt;project_name&gt;.qgs</span></code></p>
<p>For example:</p>
<p><code class="docutils literal notranslate"><span class="pre">qgis_projects/terrain/terrain.qgs</span></code></p>
<p>There is a convenience Make target that will copy your .ssh/authorized_keys
file contents into each of the scp_config user files listed in the table above.</p>
<p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">setup-scp</span></code></p>
</div>
<div class="section" id="starting-the-container">
<h2>Starting the container<a class="headerlink" href="#starting-the-container" title="Permalink to this heading">Â¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">--profile=scp</span> <span class="pre">up</span> <span class="pre">-d</span> <span class="pre">scp</span></code></p>
<p>Example copying of data into the container from the command line:</p>
<p><code class="docutils literal notranslate"><span class="pre">scp</span> <span class="pre">-P</span> <span class="pre">2222</span> <span class="pre">sample-document.txt</span> <span class="pre">localhost:/data//gis_projects/gis_projects/gis_projects</span></code></p>
<p>In Nautilus (file manager in Linux Gnome Desktop) you can test by connecting</p>
<p><code class="docutils literal notranslate"><span class="pre">sftp://&lt;hostname&gt;:2222/data/gis_projects</span></code></p>
<p>into the red highlighted box below:</p>
<p>XXXXXXXXXXXXXXXXXXXX</p>
<p>After that open a second window and you can drag and drop files too and from
the folder. Windows users can use the free WinSCP application to copy files to
the server.</p>
</div>
<div class="section" id="faq">
<h2>FAQ<a class="headerlink" href="#faq" title="Permalink to this heading">Â¶</a></h2>
<p><strong>Q:</strong> When connecting I get âHost key validation failureâ or similar
<strong>A:</strong> Remove the entry for the server in your ~/.ssh/known_hosts</p>
</div>
</div>


          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="footer-row" class="row">

    <div class="col-md-12">
        <span></span><span class="pull-right">&copy; Copyright 2021, Tim Sutton.
        Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.1.1 and the
        <a href="https://pypi.org/project/sphinx-sizzle-theme/"

           title="0.0.9/821a5457 [2020-04-16T19:31:16]"

        >Sizzle</a> theme.</span>
    </div>

  </div>
</div>

<div id="tooltips" class="hidden">
</div>

<script>
$(document).ready(function() {
  'use strict';
  var $search = $('.search-query');

  var $nav = $('#nav');

  //$('#whole-page').removeClass('hidden');
  var nav_width = $nav.width();


  var search_url = '../search.html';

  function perform_search(e) {
    var $elem;

    if (e.type === 'keypress') {
      $elem = $(e.target);
    }
    else if (e.type === 'click') {
      $elem = $(e.target).parents('.input-group').find('input');
    }
    var q = $elem.val().trim();

    if (q) {
      var url = search_url + '?q=' + q + '&check_keywords=yes&area=default';

      location.href = url;
    }
  }



  $search.on('keypress', function(e) {
    if (e.which == 13) {
      perform_search(e);
    }
  });
  $search.parents('.input-group').find('.input-group-addon').on('click', perform_search);
  $(document).on('click', '.summary .fa-caret-right', function(e) {
    var $elem = $(e.target).parents('li');
    var $next = $elem.next();
    $elem.addClass('hidden');
    $next.removeClass('hidden');
  });
  $(document).on('click', '.detail .fa-caret-down', function(e) {
    var $elem = $(e.target).parents('li');
    var $prev = $elem.prev();
    $elem.addClass('hidden');
    $prev.removeClass('hidden');
  });

  $('#content').on('click', function() {
    $('#mnav').hide();
  });

  var counter = 0;
  var timer = null;

  function show_nav() {
    $('#content').off('mousemove', track_mouse);
    if (timer !== null) {
      clearTimeout(timer);
      timer = null;
    }
    $nav.show();
  }

  function track_mouse(e) {
    var x = e.clientX;

    if (x < 15) {
      ++counter;
      if (timer === null) {
        timer = setTimeout(show_nav, 2000);
      }
    }
    else {
      counter = 0;
    }
    if (counter >= 20) {
      show_nav();
    }
  };

  function hide_nav() {
    $nav.hide();
    counter = 0;
    $('#content').on('mousemove', track_mouse);
  }

  $('.hidetoc').on('click', hide_nav);

  $(document).on('keyup', function(e) {
    if (e.ctrlKey) {
      if (e.which == 37) {      // Ctrl+left arrow
        hide_nav();
      }
      else if (e.which == 39) { // Ctrl+right arrow
        show_nav();
      }
    }
  });

  $('.menu-toggle').on('click', function(e) {
    $('#mnav').toggle();
  });

  function scroll_nav(frag) {
    var sel = '#nav ' + (frag ? 'a[href="' + frag + '"]' : '.toctree-l1 a.current');

    var $link = $(sel);

    if ($link.length > 0) {
      $link[0].scrollIntoView({block: 'center'});
    }
  }

  // If the navigator is long, then the item we clicked on to get here might
  // not be in view. Try to scroll it into the view - a slight delay is needed
  // to get it to sync properly with other stuff going on (as the page has just
  // loaded). Hence the setTimeout with a timeout of 0.

  function do_scroll() {
    scroll_nav(window.location.hash);
  }

  setTimeout(do_scroll, 0);

  function adjust_size() {
    // we need to set the height explicitly so that scrolling regions in the
    // content area work properly.
    var h = $('#page-content').height();

    $('#nav, #content').height(h);
    if ($('#nav').is(':visible')) {
      $('#mnav').hide();
    }
  }

  adjust_size();

  $(window).on('resize', adjust_size);

  function focus_content() {
    $('#content').focus();  // so that keyboard can be used to scroll, etc.
  }

  setTimeout(focus_content, 150);

  var sizzle = $(document).data('sizzle');

  function make_tooltip(id, h, b) {
    var $e = $('<div>').attr('id', id);
    var $b = $('<div>').addClass('tc-body').html(b);

    if (h) {
      var $h = $('<div>').addClass('tc-heading').html(h);
      $e.append($h);
    }
    $e.append($b);
    return $e;
  }

  var default_tt_options = {
    theme: ['tooltipster-light', 'tooltipster-light-customized'],
    interactive: true,
    maxWidth: 600,
    contentCloning: true
  };

  function activate_tooltips() {
    var $tt = $('.tt');

    //console.log('tt links:', $tt.length);
    $tt.tooltipster(default_tt_options);
  }



  function add_glossary_tooltips() {
    var links = $('a');  // can qualify with .reference.internal
    var glinks = {};
    var pat = /(.*)\.html#(term-.*)$/;
    var found = false;  // links in this document

    $.each(links, function(i, link) {
        var $link = $(link);
        var href = $link.attr('href');
        var m = href.match(pat);

        if (m) {
          var s = m[1].replace(/^(\.\.\/)+/, '');

          if (s === sizzle.app_data.glossary.document) {
            var k = m[2];

            if (k in glinks) {
              glinks[k].push($link);
            }
            else {
              glinks[k] = [$link];
            }
            found = true;
          }
        }
    });
    if (found) {
      var $t = $('#tooltips');
      var data = sizzle.app_data.glossary.terms;

      $.each(glinks, function(k, v) {
        var d = data[k];

        if (d) {  // as a sanity check
          var s = 'tc-'+ k;
          var $e = make_tooltip(s, d.term, d.defn);
          $t.append($e);

          $.each(v, function(i, link) {
            link.addClass('tt').attr('data-tooltip-content', '#' + s);
          });
        }
      });
    }
  }

  if (sizzle.app_data && sizzle.app_data.glossary &&
      sizzle.app_data.glossary.document) {
    add_glossary_tooltips();
  }




  function add_custom_tooltips() {
    var info_tips = sizzle.app_data.custom_data['info-tips'] || {};

    if ($.isEmptyObject(info_tips)) {
      return;
    }

    var tt_options = $.extend({contentAsHTML: true}, default_tt_options);

    $('.tc-info').each(function() {
      var $elem = $(this).prev();
      var classes = $elem.attr('class');
      var m = /\btci-([\S]+)/.exec(classes);

      if (m !== null) {
        var key = m[1];

        if (key in info_tips) {
          var v = info_tips[key];
          var tt = $elem.tooltipster(tt_options).tooltipster('content', v);
        }
      }
    });
  }

  add_custom_tooltips();

  setTimeout(activate_tooltips, 1000);


  // Clipboard copy for code blocks with captions

  $('.code-block-caption').each(function() {
    var $cap = $(this);
    var $btn = $('<span class="clip-copy"><span class="copied hidden">Copied!</span><i class="fa fa-clipboard" title="Copy contents"></i></span>');
    var $code = $cap.parent().find('.highlight');

    $cap.append($btn);
    $btn.find('.fa-clipboard').data('clip-text', $code.text());
  });

  var clipboard = new ClipboardJS('.code-block-caption .fa-clipboard', {
    'text': function(trigger) {
      return $(trigger).data('clip-text');
    }
  });

  clipboard.on('success', function(e) {
    var $copied = $(e.trigger).prev();

    $copied.removeClass('hidden');

    setTimeout(function() {$copied.addClass('hidden'); }, 1000);
  });

  if (sizzle.on_load) {
    sizzle.on_load.forEach(function(f) {
      f();
    });
  }
});
</script>
</body>
</html>